{% extends 'accounts/dashboard.html' %}
{% block content %}

<h3>{{ company.name }} Employees</h3>

<!-- Filter Section -->
<div class="row g-2 mb-3">
    <div class="col-md-2">
        <select id="statusFilter" class="form-control">
            <option value="">All Status</option>
            <option value="active">Active</option>
            <option value="resigned">Resigned</option>
        </select>
    </div>

    <div class="col-md-2">
        <select id="teamFilter" class="form-control">
            <option value="">All Teams</option>
            {% for team in teams %}
            <option value="{{ team.id }}">{{ team.name }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="col-md-2">
        <input type="date" id="dateFrom" class="form-control" placeholder="From Date">
    </div>

    <div class="col-md-2">
        <input type="date" id="dateTo" class="form-control" placeholder="To Date">
    </div>

    <div class="col-md-3">
        <input type="text" id="searchFilter" class="form-control" placeholder="Search employee...">
    </div>

    <div class="col-md-1">
        <button onclick="clearFilters()" class="btn btn-secondary w-100">Clear</button>
    </div>
</div>

<!-- Result Count -->
<div class="alert alert-info">
    Showing <span id="employeeCount">{{ employees.count }}</span> employee(s)
</div>

<!-- Export Buttons -->
<div class="mb-3">
    <button onclick="exportData('csv')" class="btn btn-success btn-sm">
        <i class="bi bi-file-earmark-text"></i> CSV
    </button>
    <button onclick="exportData('excel')" class="btn btn-primary btn-sm">
        <i class="bi bi-file-earmark-excel"></i> Excel
    </button>
    <button onclick="exportData('pdf')" class="btn btn-danger btn-sm">
        <i class="bi bi-file-earmark-pdf"></i> PDF
    </button>
    <button onclick="exportData('word')" class="btn btn-info btn-sm">
        <i class="bi bi-file-earmark-word"></i> Word
    </button>
    <button onclick="window.print()" class="btn btn-secondary btn-sm">
        <i class="bi bi-printer"></i> Print
    </button>
</div>

<!-- Employee Table -->
<div class="table-responsive">
    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>Name</th>
                <th>Team</th>
                <th>Role</th>
                <th>Date of Join</th>
                <th>Image</th>
                <th>Status</th>
                <th class="no-print">Actions</th>
            </tr>
        </thead>
        <tbody id="employeeTableBody">
            {% include 'employees/partials/employee_rows.html' %}
        </tbody>
    </table>
</div>

<a href="{% url 'company_list' %}" class="btn btn-secondary no-print">Back to Companies</a>

<style>
    @media print {
        .no-print {
            display: none !important;
        }
    }
</style>

<script>
    function fetchEmployees() {
        let status = document.getElementById("statusFilter").value;
        let team = document.getElementById("teamFilter").value;
        let dateFrom = document.getElementById("dateFrom").value;
        let dateTo = document.getElementById("dateTo").value;
        let search = document.getElementById("searchFilter").value;

        let url = `?status=${status}&team=${team}&date_from=${dateFrom}&date_to=${dateTo}&search=${search}`;

        fetch(url, {
            headers: { "X-Requested-With": "XMLHttpRequest" }
        })
        .then(res => res.json())
        .then(data => {
            document.getElementById("employeeTableBody").innerHTML = data.html;
            document.getElementById("employeeCount").textContent = data.count;
        })
        .catch(error => {
            console.error('Error fetching employees:', error);
        });
    }

    function clearFilters() {
        document.getElementById("statusFilter").value = "";
        document.getElementById("teamFilter").value = "";
        document.getElementById("dateFrom").value = "";
        document.getElementById("dateTo").value = "";
        document.getElementById("searchFilter").value = "";
        fetchEmployees();
    }

    function exportData(format) {
        let status = document.getElementById("statusFilter").value;
        let team = document.getElementById("teamFilter").value;
        let dateFrom = document.getElementById("dateFrom").value;
        let dateTo = document.getElementById("dateTo").value;
        let search = document.getElementById("searchFilter").value;

        let params = new URLSearchParams();
        if (status) params.append('status', status);
        if (team) params.append('team', team);
        if (dateFrom) params.append('date_from', dateFrom);
        if (dateTo) params.append('date_to', dateTo);
        if (search) params.append('search', search);
        params.append('export', format);

        window.location.href = '?' + params.toString();
    }

    // Add event listeners for live filtering
    document.querySelectorAll('#statusFilter, #teamFilter, #dateFrom, #dateTo').forEach(el => {
        el.addEventListener('change', fetchEmployees);
    });

    document.getElementById("searchFilter").addEventListener("input", fetchEmployees);
</script>

{% endblock %}